---
title: "chapter6"
author: "Susanne Csader"
date: "11/25/2020"
output: html_document
---

# Analysis of longitudinal data

### Analysis of Longitudinal Data I: GraphicalDisplays and Summary Measure Approach

*using the BPRS data*
```{r}
library(dplyr)
library(tidyr)
BPRSL <- read.csv("C:/Users/susac/Documents/R/IODS-project/data/BPRSL.csv", sep = ",", header = TRUE, row.names = 1)
glimpse(BPRSL)
dim(BPRSL)

library(dplyr)
library(tidyr)
BPRSL$treatment <- factor(BPRSL$treatment) # factor again
BPRSL$subject <- factor(BPRSL$subject)
glimpse(BPRSL)
```


*visualization of the data*
```{r}
library(ggplot2)
ggplot(BPRSL, aes(x = week, y = bprs, color = subject)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))
```

*visualization of the standardized data*
```{r}

BPRSS <- BPRSL %>%
  group_by(treatment, week) %>%
  summarise( mean = mean(bprs), se = sd(bprs)/sqrt(20) ) %>%
  ungroup()
ggplot(BPRSS, aes(x = week, y = mean, linetype = treatment, shape = treatment, color= treatment)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2)) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.8,0.8)) +
  scale_y_continuous(name = "mean(bprs) +/- se(bprs)")
```


*Applying the summary approach*
```{r}
library(dplyr)
library(tidyr)
BPRSL8S <- BPRSL %>%
  filter(week > 0) %>%
  group_by(treatment, subject) %>%
  summarise( mean=mean(bprs) ) %>%
  ungroup() 
glimpse(BPRSL8S)

# visualization with outliers
ggplot(BPRSL8S, aes(x = treatment, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "green") +
  scale_y_continuous(name = "mean(bprs), weeks 1-8")

#visualization without outlier

BPRSL8S1 <- BPRSL8S %>%
  filter(mean < 60)

ggplot(BPRSL8S1, aes(x = treatment, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "blue") +
  scale_y_continuous(name = "mean(bprs), weeks 1-8 without outlier")
```

*t-Test* 
```{r}
t.test(mean ~ treatment, data = BPRSL8S1, var.equal = TRUE)
```

*Covariance analysis*
```{r}
# only used the long wide data, and I don't know yet how to convert them in wide form again, I sued the original data agin

BPRS<-read.table("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/BPRS.txt", sep="", header=TRUE)
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)

BPRSL8S2 <- BPRSL8S %>%
  mutate(baseline = BPRS$week0)
fit <- lm(mean ~ baseline + treatment, data = BPRSL8S2)
anova(fit)
```

### Analysis of Longitudinal Data II: LinearMixed Effects Models for Normal ResponseVariables

*using the RATS data*
```{r}
library(dplyr)
library(tidyr)
RATSL <- read.csv("C:/Users/susac/Documents/R/IODS-project/data/RATSL.csv", sep = ",", header = TRUE, row.names = 1)
glimpse(RATSL)
dim(RATSL)

library(dplyr)
library(tidyr)
RATSL$ID <- factor(RATSL$ID) #factor again
RATSL$Group <- factor(RATSL$Group)
glimpse(RATSL)
```

*visualization*

```{r}
ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) +
  scale_y_continuous(name = "Weight (grams)") +
  theme(legend.position = "right")
```

*Linear Regression Model*
```{r}
RATS_reg<-lm(Weight~Time+Group, RATSL)
summary(RATS_reg)
```

*Random Intercept Model*
```{r}
library(lme4)
RATS_ref <- lmer(Weight ~ Time + Group + (1 | ID), data = RATSL, REML = FALSE)
summary(RATS_ref)
```


*Random Intercept and Random Slope Model*
```{r}
RATS_ref1 <- lmer(Weight ~ Time + Group + (Time | ID), data = RATSL, REML = FALSE)
summary(RATS_ref1)
anova(RATS_ref1, RATS_ref)
```


*Random Intercept and Random Slope Model with interaction*
```{r}
RATS_ref2 <- lmer(Weight ~ Time * Group + (Time | ID), data = RATSL, REML = FALSE)
summary(RATS_ref2)
anova(RATS_ref2, RATS_ref1)
ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 20)) +
  scale_y_continuous(name = "Observed weight (grams)") +
  theme(legend.position = "top")
Fitted<-fitted(RATS_ref2)
RATSL <- RATSL %>%
  mutate(Fitted)
ggplot(RATSL, aes(x = Time, y = Fitted, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 20)) +
  scale_y_continuous(name = "Fitted weight (grams)") +
  theme(legend.position = "top")
```


![Amazing, how short 6 weeks can be](https://media.giphy.com/media/bg1MQ6IUVoVOM/giphy.gif)